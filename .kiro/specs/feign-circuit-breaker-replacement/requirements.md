# 需求文档

## 介绍

此功能旨在将Spring Cloud Gateway中基于Resilience4j的熔断器功能替换为基于Feign客户端的服务调用模式。当前网关服务使用Spring Cloud Gateway的路由机制配合Resilience4j熔断器来处理下游服务调用，但这种方式在服务调用、错误处理和配置管理方面存在复杂性。通过引入Feign客户端，我们可以获得更统一的服务调用模式、内置的负载均衡、熔断和重试机制，同时简化配置管理。

## 需求

### 需求 1

**用户故事：** 作为网关服务，我希望使用Feign客户端替代Gateway路由进行所有下游服务调用，以便获得更一致的服务通信模式和更好的容错能力。

#### 验收标准

1. 当客户端向/user/**路径发送请求时，网关应使用UserServiceClient（Feign客户端）调用用户服务
2. 当客户端向/product/**路径发送请求时，网关应使用ProductServiceClient（Feign客户端）调用产品服务
3. 当进行Feign客户端调用时，系统应自动处理请求路径的转换（移除网关前缀）
4. 当服务调用成功时，系统应返回下游服务的原始响应

### 需求 2

**用户故事：** 作为系统管理员，我希望使用Feign内置的熔断器机制替代Resilience4j，以便简化配置和统一错误处理。

#### 验收标准

1. 当下游服务不可用时，Feign客户端应自动触发熔断器并调用回退方法
2. 当服务调用超时时，系统应使用Feign的超时配置而不是Gateway的超时配置
3. 当熔断器开启时，系统应返回预定义的回退响应而不是Resilience4j的回退
4. 当服务恢复时，Feign熔断器应自动恢复正常调用

### 需求 3

**用户故事：** 作为开发人员，我希望有统一的错误处理和响应格式，以便客户端收到一致的错误响应，无论调用哪个下游服务。

#### 验收标准

1. 当下游服务返回4xx错误时，网关应透传原始错误响应
2. 当下游服务返回5xx错误时，网关应返回统一格式的错误响应
3. 当服务不可用时，系统应返回503状态码和标准化的错误消息
4. 当请求超时时，系统应返回408状态码和超时错误消息

### 需求 4

**用户故事：** 作为网关服务，我希望保持现有的路径匹配和路由逻辑，以便在不影响客户端的情况下完成内部实现的替换。

#### 验收标准

1. 当客户端发送请求到/user/profile时，系统应路由到用户服务的/profile端点
2. 当客户端发送请求到/product/list时，系统应路由到产品服务的/list端点
3. 当请求包含查询参数时，系统应完整转发所有参数到下游服务
4. 当请求包含请求体时，系统应完整转发请求体到下游服务

### 需求 5

**用户故事：** 作为系统操作员，我希望移除Resilience4j相关的配置和依赖，以便简化系统架构和减少维护复杂度。

#### 验收标准

1. 当系统启动时，不应加载任何Resilience4j相关的配置类
2. 当查看项目依赖时，不应包含spring-cloud-starter-circuitbreaker-reactor-resilience4j
3. 当查看配置文件时，不应包含resilience4j相关的配置项
4. 当系统运行时，不应暴露circuitbreakers和circuitbreakerevents监控端点

### 需求 6

**用户故事：** 作为网关服务，我希望支持动态服务发现，以便可以与服务注册中心配合工作，提高系统的可扩展性。

#### 验收标准

1. 当配置Feign客户端时，系统应支持直接URL配置和服务发现两种模式
2. 当使用服务发现时，系统应将服务名称解析为实际的服务实例
3. 当服务实例变得不可用时，系统应自动路由到健康的实例
4. 当没有可用的服务实例时，系统应返回适当的错误响应