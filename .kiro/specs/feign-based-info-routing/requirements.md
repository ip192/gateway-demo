# 需求文档

## 介绍

此功能旨在重构现有的InfoRoutingFilter实现，使用Feign客户端进行服务通信，而不是依赖Spring Cloud Gateway路由。当前实现存在重复配置和混合路由机制的问题。此重构将通过Feign客户端统一服务调用，提供更好的服务发现、负载均衡、熔断和配置管理。

## 需求

### 需求 1

**用户故事：** 作为网关服务，我希望对所有下游服务调用使用Feign客户端，以便拥有一致的服务通信模式和更好的容错能力。

#### 验收标准

1. 当向/info端点发送POST请求时，系统应使用Feign客户端调用下游服务
2. 当InfoRoutingFilter处理请求时，它应根据ID前缀确定目标服务并使用相应的Feign客户端
3. 当进行Feign客户端调用时，它应包含适当的请求体转发和响应处理
4. 当服务调用失败时，系统应使用Feign内置的熔断器和回退机制

### 需求 2

**用户故事：** 作为系统管理员，我希望有集中的服务配置，以便在一个地方管理服务URL和连接设置。

#### 验收标准

1. 当配置服务时，系统应使用单一配置源来管理服务URL和连接设置
2. 当创建Feign客户端时，它们应从InfoRoutingProperties读取配置而不是硬编码URL
3. 当服务配置更改时，它应反映在路由逻辑和Feign客户端调用中
4. 当应用程序启动时，它应验证所有必需的服务配置都存在

### 需求 3

**用户故事：** 作为开发人员，我希望有适当的错误处理和响应映射，以便客户端收到一致的错误响应，无论调用哪个下游服务。

#### 验收标准

1. 当下游服务返回错误时，网关应将其映射为一致的错误格式
2. 当下游服务不可用时，系统应返回适当的回退响应
3. 当请求验证失败时，系统应返回适当的HTTP状态码和错误消息
4. 当发生超时时，系统应返回带有适当HTTP状态的超时错误

### 需求 4

**用户故事：** 作为网关服务，我希望支持动态服务发现，以便可以与服务注册中心配合工作，而不依赖硬编码的IP地址。

#### 验收标准

1. 当配置Feign客户端时，它们应支持直接URL配置和服务发现
2. 当使用服务发现时，系统应将服务名称解析为实际的服务实例
3. 当服务实例变得不可用时，系统应自动路由到健康的实例
4. 当没有可用的服务实例时，系统应返回适当的错误响应

### 需求 5

**用户故事：** 作为系统操作员，我希望有全面的日志记录和监控，以便可以排查问题和监控服务健康状况。

#### 验收标准

1. 当处理请求时，系统应记录路由决策和目标服务
2. 当进行Feign客户端调用时，它应在适当的日志级别记录请求/响应详细信息
3. 当发生错误时，应记录足够的上下文信息以便排查问题
4. 当熔断器激活时，系统应记录熔断器状态变化